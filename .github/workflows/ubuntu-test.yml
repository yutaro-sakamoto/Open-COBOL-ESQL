name: Open-COBOL-ESQL tests on Ubuntu
on: [push]
jobs:
  Open-COBOL-ESQL-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5 libncurses5-dev libgmp-dev bison flex gettext automake autoconf
          sudo apt-get install -y libpq-dev postgresql postgresql-contrib

      - name: Setup PostgreSQL server
        run: |
          sudo /etc/init.d/postgresql restart
          sudo -u postgres expect -c '
            set timeout 5
            spawn createuser -h localhost -p 5432 -U postgres -d -l -s -P main_user
            expect "Enter password for new role:"
            send password
            expect "Enter it again:"
            send password
            exit 0
          '
          sudo -u postgres createdb testdb --encoding=Shift_JIS --owner=main_user
          PGPASSWORD=password psql -h localhost -p 5432 -U main_user -d testdb
