name: Open-COBOL-ESQL tests on Ubuntu
on:
  push:
    branches:
      - main
      - 'feature/**'
      - 'develop/**'
jobs:
  Open-COBOL-ESQL-tests:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:9.6
        ports: 
          - 5432:5432
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_USER: main_user
          POSTGRES_DB: testdb
          POSTGRES_HOST_AUTH_METHOD: 'trust'
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5 libncurses5-dev libgmp-dev bison flex gettext automake autoconf
          sudo apt-get install -y libpq-dev postgresql postgresql-contrib
      
      - name: Cache opnesource COBOL v1.5.2J
        id: opensource_cobol_cache_id
        uses: actions/cache@v2
        with:
          path: opensource-cobol-1.5.2J
          key: opensource-cobol-1.5.2J-key
          

      - name: Download and Build opensource COBOL v1.5.2J
        if: steps.opensource_cobol_cache_id.outputs.cache-hit != 'true'
        run: |
          curl -L -o opensource-cobol-1.5.2J.tar.gz https://github.com/opensourcecobol/opensource-cobol/archive/refs/tags/v1.5.2J.tar.gz
          tar zxvf opensource-cobol-1.5.2J.tar.gz
          cd opensource-cobol-1.5.2J/vbisam
          ./configure --prefix=/usr/
          make
          sudo make install
          cd ../
          ./configure --prefix=/usr/ --with-vbisam
          make
          cd ../
          
      - name: Install opensource COBOL v1.5.2J
        run: |
          cd opensource-cobol-1.5.2J/vbisam
          sudo make install
          cd ../
          sudo make install
          cd ../

      - name: Checkout Open-COBOL-ESQL
        uses: actions/checkout@v2
        with:
          path: Open-COBOL-ESQL
          
      - name: Install Open-COBOL-ESQL
        run: |
          cd Open-COBOL-ESQL
          touch * # Without this instructions, the following './configure' command fails.
          ./configure
          C_INCLUDE_PATH=/usr/include/postgresql/ make
          sudo make install
      
      - name: Create a log directory
        run: |
          mkdir Open-COBOL-ESQL/log
          mkdir Open-COBOL-ESQL/log/test
          mkdir Open-COBOL-ESQL/log/static-analysis

      - name: Run tests
        run: |
          cd Open-COBOL-ESQL/tests
          make clean
          cp ../.github/workflows/ubuntu-test-settings/atlocal atlocal
          cp ../.github/workflows/ubuntu-test-settings/embed_db_info.sh embed_db_info.sh
          make
          ./basic || true
          ./cobol_data || true
          ./sql_data || true
          ./sqlca || true
          cp -r basic.dir cobol_data.dir sql_data.dir sqlca.dir *.log ../log/test
          cd ../
            


      - name: Push log to branch 'cicd/log'
        env:
            GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          cd Open-COBOL-ESQL/
          git remote set-url origin https://github-actions:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git add log/*
          git commit -m "CI/CD log. RUN-ID ${GITHUB_RUN_ID}"; \
          git push origin HEAD:cicd/log; 
      
      - name: Archive test results
        uses: actions/upload-artifact@v2
        with:
          name: ubuntu-log
          path: Open-COBOL-ESQL/log/*
